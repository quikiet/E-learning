<p-toolbar styleClass="mb-4">
  <ng-template #start>
    <p-button
      [outlined]="true"
      icon="pi pi-filter-slash"
      label="Clear"
      class="mr-2"
      (click)="clear(dt)"
    />
  </ng-template>

  <ng-template #end>
    <div class="flex items-center gap-2 flex-wrap">
      <p-button
        label="Filter"
        icon="pi pi-filter"
        severity="warn"
        (click)="showFilterDialog()"
      />
      <p-button
        label="Export"
        (click)="dt.exportCSV()"
        icon="pi pi-upload"
        severity="info"
      />
      <p-button
        label="Create Admin"
        icon="pi pi-plus"
        severity="success"
        (click)="showCreateAdminDialog()"
      />
    </div>
  </ng-template>
</p-toolbar>

<p-table
  class="w-full"
  #tableUser
  [value]="users"
  [columns]="cols"
  [lazy]="true"
  (onLazyLoad)="loadUserData($event)"
  [first]="currentPage * rows"
  [rows]="rows"
  [totalRecords]="totalRecords"
  [paginator]="true"
  [globalFilterFields]="['id', 'username', 'email']"
  [(selection)]="selectedUsers"
  [rowHover]="true"
  dataKey="id"
  currentPageReportTemplate="Hiển thị từ {first} đến {last} của {totalRecords} người dùng"
  [showCurrentPageReport]="true"
  [loading]="isLoading"
>
  <ng-template #caption>
    <div class="flex items-center justify-between flex-wrap gap-2 md:p-0 p-2">
      <p class="m-0 lg:text-lg font-semibold">User management</p>
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input
          pInputText
          type="text"
          (input)="searchGlobal($event)"
          [(ngModel)]="searchValue"
          placeholder="Search..."
        />
      </p-iconfield>
    </div>
  </ng-template>
  <ng-template #header>
    <tr class="text-sm">
      <th>ID</th>
      <th>Email</th>
      <th>Username</th>
      <th>Fullname</th>
      <th>Gender</th>
      <th>Birthdate</th>
    </tr>
  </ng-template>
  <ng-template #body let-user>
    <tr class="text-sm" (click)="showUser(user)">
      <td>{{ user.id }}</td>
      <td>
        <div class="flex items-center gap-2">
          <p-avatar
            [image]="
              user.avatar ||
              'https://winaero.com/blog/wp-content/uploads/2017/12/User-icon-256-blue.png'
            "
            shape="circle"
          />
          <div>
            <span
              [tooltipDisabled]="user.email.length < 20"
              [pTooltip]="user.email"
              tooltipPosition="right"
              >{{ cutText(user.email, 20) }}</span
            >
            <div>
              <p-tag
                [severity]="
                  user.role === 'admin'
                    ? 'danger'
                    : user.role === 'student'
                    ? 'success'
                    : 'info'
                "
                [value]="user.role"
                [rounded]="true"
                class="!text-xs"
              />
            </div>
          </div>
        </div>
      </td>
      <td>{{ user.username }}</td>
      <td>{{ user.fullname }}</td>
      <td class="text-center align-middle">{{ user.gender || "NaN" }}</td>
      <td>{{ user.created_at | date }}</td>
    </tr>
  </ng-template>
</p-table>
<p-drawer
  [(visible)]="visibleDrawer"
  position="right"
  [dismissible]="false"
  (onHide)="visibleDrawer = false"
  modal="false"
  styleClass="!w-full sm:!w-[35rem] md:!w-[25rem]"
>
  <ng-template #header>
    <div class="flex items-center gap-2">
      <p-avatar
        [styleClass]="'lazy-avatar'"
        [image]="
          user.avatar ||
          'https://winaero.com/blog/wp-content/uploads/2017/12/User-icon-256-blue.png'
        "
        shape="circle"
      />
      <span>
        <div>
          <p-tag
            *ngIf="user.role === 'admin'"
            severity="danger"
            [value]="user.role"
            [rounded]="true"
            class="!text-xs"
          />
          <p-tag
            *ngIf="user.role === 'student'"
            severity="success"
            class="!text-xs"
            [value]="user.role"
            [rounded]="true"
          />
          <p-tag
            *ngIf="user.role === 'instructor'"
            severity="info"
            class="!text-xs"
            [value]="user.role"
            [rounded]="true"
          /></div
      ></span>
      <a [routerLink]="[user.id]"
        ><i class="pi pi-window-maximize text-sm ml-2"></i
      ></a>
    </div>
  </ng-template>
  <ng-template #content>
    <div class="flex flex-col gap-2 lg:p-2 p-6">
      <div class="flex items-center gap-2 lg:flex-row flex-col lg:gap-5">
        <img
          [src]="user.avatar"
          [alt]="user.avatar"
          class="block w-32 h-32 md:w-64 md:h-64 lg:h-28 lg:w-28 border rounded-md"
          *ngIf="user.avatar"
        />
        <!-- <div class="">
          <p-image
            alt="Image"
            [src]="
              user.avatar ||
              'https://primefaces.org/cdn/primeng/images/galleria/galleria10.jpg'
            "
            [alt]="user.avatar"
            class="!w-32 !h-64 !lg:h-32 !lg:w-32"
            [preview]="true"
          />
        </div> -->

        <div class="flex h-full w-full flex-col justify-between gap-5">
          <div
            class="flex lg:items-center lg:flex-row flex-col gap-2 lg:gap-5 lg:justify-between w-full pr-5"
          >
            <div>
              <label class="text-sm block">Email</label>
              <span class="text-sm text-secondary">{{ user.email }}</span>
            </div>
            <div>
              <label class="text-sm block">Gender</label>
              <span class="text-sm text-secondary">{{ user.gender }}</span>
            </div>
          </div>
          <div class="flex items-center gap-5 justify-between w-full pr-5">
            <div>
              <label class="text-sm block">Username</label>
              <span class="text-sm text-secondary">{{ user.username }}</span>
            </div>
          </div>
        </div>
      </div>
      <div>
        <strong>Created at:</strong>
        {{ user.created_at | date : "dd/MM/yyyy HH:mm" }}
      </div>
      <div>
        <strong>Updated at:</strong>
        {{ user.updated_at | date : "dd/MM/yyyy HH:mm" }}
      </div>
      <div class="flex flex-wrap gap-5">
        <div>
          <label class="block font-semibold mb-2">Trình độ học vấn</label>
          <span class="text-sm text-secondary">{{ user.LoE_DI }}</span>
        </div>
        <div>
          <label class="block font-semibold mb-2">Birthdate</label>
          <span class="text-sm text-secondary">{{
            user.birthdate | date
          }}</span>
        </div>
      </div>
    </div>
  </ng-template>
  <ng-template #footer>
    <div class="flex justify-center w-full">
      <p-button
        (onClick)="deleteUser(user.id)"
        label="Temporary lock"
        icon="pi pi-lock"
        [disabled]="true"
        severity="danger"
      />
    </div>
  </ng-template>
</p-drawer>

<p-dialog
  [(visible)]="createAdminDialog"
  header="Create Admin"
  [modal]="true"
  [style]="{ width: '30rem' }"
>
  <form [formGroup]="adminForm" class="flex flex-col gap-4">
    <app-form-element label="Email" [control]="adminForm.get('email')!">
      <input
        pInputText
        id="email"
        formControlName="email"
        class="w-full"
        [ngClass]="{
          'ng-invalid ng-dirty': submitted && adminForm.controls.email.errors
        }"
      />
    </app-form-element>
    <app-form-element label="Password" [control]="adminForm.get('password')!">
      <input
        pInputText
        id="password"
        type="password"
        formControlName="password"
        class="w-full"
        [ngClass]="{
          'ng-invalid ng-dirty': submitted && adminForm.controls.password.errors
        }"
      />
    </app-form-element>
  </form>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      severity="secondary"
      (click)="createAdminDialog = false"
    />
    <p-button label="Create" severity="success" (click)="createAdmin()" />
  </ng-template>
</p-dialog>

<p-dialog
  [(visible)]="filterDialog"
  header="Filter Users"
  [modal]="true"
  [style]="{ width: '50rem' }"
  [breakpoints]="{ '1199px': '75vw', '575px': '90vw' }"
  [maximizable]="true"
>
  <form [formGroup]="filterForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div>
      <label for="role" class="block font-medium mb-1">Role</label>
      <p-select
        id="role"
        formControlName="role"
        [options]="roleOptions"
        optionLabel="label"
        optionValue="value"
        class="w-full"
        placeholder="Select Role"
      />
    </div>
    <div>
      <label for="gender" class="block font-medium mb-1">Gender</label>
      <p-select
        id="gender"
        formControlName="gender"
        [options]="genderOptions"
        optionLabel="label"
        optionValue="value"
        class="w-full"
        placeholder="Select Gender"
      />
    </div>
    <div>
      <label for="username" class="block font-medium mb-1">Username</label>
      <input
        pInputText
        id="username"
        formControlName="username"
        class="w-full"
      />
    </div>
    <div>
      <label for="fullname" class="block font-medium mb-1">Fullname</label>
      <input
        pInputText
        id="fullname"
        formControlName="fullname"
        class="w-full"
      />
    </div>
    <div>
      <label for="email" class="block font-medium mb-1">Email</label>
      <input pInputText id="email" formControlName="email" class="w-full" />
    </div>

    <div>
      <label for="birthdate" class="block font-medium mb-1">Birthdate</label>
      <input
        pInputText
        id="birthdate"
        type="date"
        formControlName="birthdate"
        class="w-full"
      />
    </div>
  </form>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      severity="secondary"
      (click)="filterDialog = false"
    />
    <p-button
      label="Apply Filters"
      severity="success"
      (click)="applyFilters()"
    />
  </ng-template>
</p-dialog>

<p-toast />
