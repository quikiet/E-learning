<p-toast></p-toast>
<div>
  <h2 class="text-2xl font-bold text-gray-800 mb-6">Your course is on sale</h2>

  <!-- Tìm kiếm và lọc -->
  <!-- <div class="flex items-center justify-between mb-6">
    <div class="flex gap-2">
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input
          pInputText
          type="text"
          [(ngModel)]="searchKeyword"
          (input)="filterCourses()"
          placeholder="Tìm kiếm khóa học..."
          class="p-2 border border-gray-300 rounded-md"
        />
      </p-iconfield>
      <p-dropdown
        [options]="categories"
        [(ngModel)]="selectedCategory"
        placeholder="Chọn danh mục"
        optionLabel="name"
        optionValue="id"
        (onChange)="filterCourses()"
        styleClass="w-[200px]"
      ></p-dropdown>
    </div>
    <button
      pButton
      label="Xóa bộ lọc"
      icon="pi pi-times"
      class="p-button-secondary"
      (click)="clearFilters()"
    ></button>
  </div> -->

  <!-- Grid layout cho các card khóa học -->
  <div
    *ngIf="courses.length > 0; else noCourses"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-10"
  >
    <div
      *ngFor="let course of courses"
      class="bg-white shadow-lg rounded-lg overflow-hidden hover:shadow-xl transition-shadow duration-200"
    >
      <div class="relative">
        <img
          [src]="course.image || 'https://via.placeholder.com/300x150'"
          alt="{{ course.course_name }}"
          class="w-full h-40 object-cover"
        />
        <div
          class="absolute top-5 right-5"
          pTooltip="{{ getNotes(course.coursereview) }}"
          tooltipPosition="bottom"
        >
          <p-tag
            *ngIf="course.status === 'approved'"
            severity="success"
            value="Đang bán"
            [rounded]="true"
            class="!text-xs"
          />
          <p-tag
            *ngIf="course.status === 'draft'"
            severity="secondary"
            [value]="course.status"
            [rounded]="true"
            class="!text-xs"
          />
          <p-tag
            *ngIf="course.status === 'pending'"
            severity="warn"
            class="!text-xs"
            value="Đang chờ"
            [rounded]="true"
          />
          <p-tag
            *ngIf="course.status === 'rejected'"
            severity="danger"
            class="!text-xs"
            value="Bị từ chối"
            [rounded]="true"
          />
          <p-tag
            *ngIf="course.status === 'unavailable'"
            severity="secondary"
            class="!text-xs"
            value="Đã ẩn"
            [rounded]="true"
          />
        </div>
        <div class="absolute top-5 left-5">
          <span
            (click)="openEditDialog(course)"
            class="rounded-full bg-secondary-content hover:bg-secondary w-8 h-8 cursor-pointer"
            ><i class="pi pi-file-edit p-2"></i
          ></span>
        </div>
      </div>
      <div class="p-4">
        <h3
          class="text-lg font-semibold text-gray-800 mb-2 truncate"
          [title]="course.course_name"
        >
          {{ course.course_name }}
        </h3>
        <p class="text-sm text-gray-600 mb-1">
          <i class="pi pi-star mr-1"></i> Mức độ:
          {{ course.difficulty_level }}
        </p>
        <div class="flex items-center mb-1">
          <span class="text-sm text-gray-600 mr-1">
            <i class="pi pi-star-fill text-yellow-500 mr-1"></i>
            {{ course.course_rating | number : "1.1-1" }}
          </span>
          <span class="text-xs text-gray-500"
            >({{
              course.course_rating >= 4
                ? "Xuất sắc"
                : course.course_rating >= 3
                ? "Tốt"
                : "Trung bình"
            }})</span
          >
        </div>
        <p class="text-sm font-medium text-gray-800 mb-1">
          <i class="pi pi-money-bill mr-1"></i>
          {{ course.price | number }} VND
        </p>
        <p class="text-sm text-gray-600 mb-2">
          <i class="pi pi-book mr-1"></i> Tổng bài học:
          {{ course.lessons_count }}
        </p>
        <div class="flex gap-2">
          <button
            (click)="navigateToAddLesson(course.id)"
            class="w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-200 text-sm font-medium"
          >
            Add lesson
          </button>
          <button
            (click)="showLessons(course.id)"
            class="w-full bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-200 text-sm font-medium"
          >
            View detail lesson
          </button>
        </div>
      </div>
    </div>
  </div>
  <ng-template #noCourses>
    <p class="text-center text-gray-500 py-4">Không tìm thấy khóa học nào.</p>
  </ng-template>

  <p-paginator
    [rows]="perPage"
    [totalRecords]="totalRecords"
    (onPageChange)="onPageChange($event)"
    [first]="(currentPage - 1) * perPage"
    class="mt-6"
  ></p-paginator>
</div>

<!-- Dialog hiển thị danh sách bài học -->
<p-dialog
  [(visible)]="showLessonsDialog"
  [style]="{ width: '700px' }"
  header="Lessons list"
  [modal]="true"
  class="rounded-lg shadow-lg"
>
  <ng-template pTemplate="content">
    <div *ngIf="selectedCourseLessons.length > 0; else noLessons">
      <div class="max-h-[400px] overflow-y-auto">
        <div
          *ngFor="let lesson of selectedCourseLessons"
          class="border-b border-gray-200 py-3"
        >
          <div class="flex items-center justify-between">
            <div>
              <h4
                class="text-md font-semibold text-gray-800"
                [pTooltip]="lesson.title"
                tooltipPosition="right"
              >
                {{ cutText(lesson.title, 5) }}
              </h4>
              <p class="text-sm text-gray-600">
                <i class="pi pi-clock mr-1"></i> Duration:
                {{ lesson.duration }} minutes
              </p>
              <p class="text-sm text-gray-600">
                <i class="pi pi-eye mr-1"></i> Preview:
                {{ lesson.is_preview ? "Yes" : "No" }}
              </p>
              <p class="text-sm text-gray-600">
                <i class="pi pi-tag mr-1"></i> Version: {{ lesson.version }}
              </p>
            </div>
            <div class="flex gap-2 justify-center items-center">
              <p-button
                label="Quản lý bài tập"
                severity="success"
                [routerLink]="['/danh-sach-bai-tap', lesson.id]"
              />
            </div>
            <div class="flex flex-col">
              <video
                controls
                [src]="lesson.video_url"
                class="w-48 h-28"
                type="video/mp4"
              >
                Your browser does not support the video tag.
              </video>
              <div>
                <p-button
                  (click)="deleteLesson(lesson.id)"
                  icon="pi pi-trash"
                  label="Delete"
                  severity="danger"
                />
                <p-button
                  (click)="openEditLessonDialog(lesson)"
                  icon="pi pi-file-edit"
                  label="Edit"
                  severity="info"
                  [disabled]="lesson.origin_id && lesson.version === 1"
                />
              </div>
            </div>
          </div>
        </div>
      </div>
      <p-paginator
        [rows]="lessonsPerPage"
        [totalRecords]="lessonsTotalRecords"
        (onPageChange)="onLessonsPageChange($event)"
        [first]="(lessonsCurrentPage - 1) * lessonsPerPage"
        class="mt-4"
      ></p-paginator>
    </div>
    <ng-template #noLessons>
      <p class="text-center text-gray-500 py-4">
        Chưa có bài học nào cho khóa học này.
      </p>
    </ng-template>
  </ng-template>
  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="Đóng"
      icon="pi pi-times"
      class="p-button-text text-gray-700 hover:bg-gray-100 transition duration-200"
      (click)="showLessonsDialog = false"
    ></button>
  </ng-template>
</p-dialog>

<!-- Dialog chỉnh sửa khóa học -->
<p-dialog
  [(visible)]="showEditDialog"
  [style]="{ width: '600px' }"
  header="Update course"
  [modal]="true"
  class="rounded-lg shadow-lg"
>
  <ng-template pTemplate="content">
    <form (ngSubmit)="updateCourse()" #courseForm="ngForm">
      <div class="p-4 grid grid-cols-1 gap-4">
        <div class="mb-4">
          <label
            for="course_name"
            class="block text-sm font-medium text-gray-700"
          >
            Course name <span class="text-red-500">*</span>
          </label>
          <input
            id="course_name"
            name="course_name"
            [(ngModel)]="course.course_name"
            required
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
            [ngClass]="{
              'border-red-500':
                courseForm.submitted &&
                courseForm.controls['course_name']?.invalid
            }"
          />
          <div
            *ngIf="
              courseForm.submitted &&
              courseForm.controls['course_name']?.invalid
            "
            class="text-red-500 text-sm mt-1"
          >
            Please enter the course name.
          </div>
        </div>
        <div class="mb-4">
          <label
            for="difficulty_level"
            class="block text-sm font-medium text-gray-700"
          >
            Difficult level
          </label>
          <p-dropdown
            id="difficulty_level"
            name="difficulty_level"
            [(ngModel)]="course.difficulty_level"
            [options]="difficultyLevels"
            optionLabel="label"
            optionValue="value"
            class="w-full"
          ></p-dropdown>
        </div>
        <div class="mb-4">
          <label
            for="course_description"
            class="block text-sm font-medium text-gray-700"
          >
            Description
          </label>
          <textarea
            id="course_description"
            name="course_description"
            [(ngModel)]="course.course_description"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
            rows="4"
          ></textarea>
        </div>
        <div class="mb-4">
          <label for="skills" class="block text-sm font-medium text-gray-700">
            Skills
          </label>
          <input
            id="skills"
            name="skills"
            [(ngModel)]="course.skills"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
          />
        </div>
        <div class="mb-4">
          <label for="price" class="block text-sm font-medium text-gray-700">
            Price ($) <span class="text-primary">*</span>
          </label>
          <input
            type="number"
            id="price"
            name="price"
            [(ngModel)]="course.price"
            required
            min="0"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
            [ngClass]="{
              'border-red-500':
                courseForm.submitted && courseForm.controls['price']?.invalid
            }"
          />
          <div
            *ngIf="
              courseForm.submitted && courseForm.controls['price']?.invalid
            "
            class="text-red-500 text-sm mt-1"
          >
            Please fill course price.
          </div>
        </div>
        <div class="mb-4">
          <label for="image" class="block text-sm font-medium text-gray-700">
            Thumbnail
          </label>
          <input
            type="file"
            id="image"
            name="image"
            (change)="onImageSelected($event)"
            accept="image/*"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
          />
          <div *ngIf="selectedCourse?.image" class="mt-2">
            <p>Current thumbnail:</p>
            <img
              [src]="selectedCourse.image"
              alt="Course Image"
              class="w-32 h-32 object-cover rounded-lg"
            />
          </div>
        </div>
        <div class="mb-4">
          <label
            for="category_ids"
            class="block text-sm font-medium text-gray-700"
          >
            Categories <span class="text-red-500">*</span>
          </label>
          <p-multiSelect
            id="category_ids"
            name="category_ids"
            [(ngModel)]="selectedCategories"
            [options]="categories"
            optionLabel="name"
            optionValue="id"
            placeholder="Select categories"
            class="w-full"
            required
            #categoryIds="ngModel"
          ></p-multiSelect>
          <div
            *ngIf="courseForm.submitted && categoryIds.invalid"
            class="text-red-500 text-sm mt-1"
          >
            Please select at least one category.
          </div>
        </div>
      </div>
      <div class="p-4 flex justify-end gap-2">
        <button
          type="button"
          (click)="showEditDialog = false"
          class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-200"
        >
          Hủy
        </button>
        <button
          type="submit"
          [disabled]="courseForm.invalid || isSubmitting"
          class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          {{ isSubmitting ? "Updating..." : "Submit" }}
        </button>
      </div>
    </form>
  </ng-template>
</p-dialog>

<!-- Dialog chỉnh sửa bài học -->
<p-dialog
  [(visible)]="showEditLessonDialog"
  [style]="{ width: '600px' }"
  header="Chỉnh sửa bài học"
  [modal]="true"
  class="rounded-lg shadow-lg"
>
  <ng-template pTemplate="content">
    <form (ngSubmit)="updateLesson()" #lessonForm="ngForm">
      <div class="p-4 grid grid-cols-1 gap-4">
        <div class="mb-4">
          <label
            for="lesson_title"
            class="block text-sm font-medium text-gray-700"
          >
            Tiêu đề bài học <span class="text-red-500">*</span>
          </label>
          <input
            id="lesson_title"
            name="lesson_title"
            [(ngModel)]="lesson.title"
            required
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
            [ngClass]="{
              'border-red-500':
                lessonForm.submitted &&
                lessonForm.controls['lesson_title']?.invalid
            }"
          />
          <div
            *ngIf="
              lessonForm.submitted &&
              lessonForm.controls['lesson_title']?.invalid
            "
            class="text-red-500 text-sm mt-1"
          >
            Vui lòng nhập tiêu đề bài học.
          </div>
        </div>
        <div class="mb-4">
          <label
            for="lesson_duration"
            class="block text-sm font-medium text-gray-700"
          >
            Thời lượng (phút) <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            id="lesson_duration"
            name="lesson_duration"
            [(ngModel)]="lesson.duration"
            [disabled]="true"
            min="1"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray/30"
          />
          <div
            *ngIf="
              lessonForm.submitted &&
              lessonForm.controls['lesson_duration']?.invalid
            "
            class="text-red-500 text-sm mt-1"
          >
            Vui lòng nhập thời lượng hợp lệ.
          </div>
        </div>
        <div class="mb-4">
          <label class="flex items-center text-sm font-medium text-gray-700">
            <input
              type="checkbox"
              id="is_preview"
              name="is_preview"
              [(ngModel)]="lesson.is_preview"
              class="mr-2"
            />
            Cho phép xem trước
          </label>
        </div>
        <div class="mb-4">
          <label for="video" class="block text-sm font-medium text-gray-700">
            Video bài học
          </label>
          <input
            type="file"
            id="video"
            name="video"
            (change)="onVideoSelected($event)"
            accept="video/*"
            class="mt-1 block w-full p-2 border border-gray-300 rounded-md"
          />
          <div *ngIf="uploadProgress > 0 && isSubmittingLesson" class="mt-2">
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div
                class="bg-blue-500 h-2.5 rounded-full"
                [style.width]="uploadProgress + '%'"
              ></div>
            </div>
            <p class="text-sm text-gray-600 mt-1">
              Đang upload: {{ uploadProgress }}%
            </p>
          </div>
          <div *ngIf="selectedLesson?.video_url" class="mt-2">
            <p>Video hiện tại:</p>
            <video
              class="w-52 h-32"
              controls
              [src]="selectedLesson.video_url"
              type="video/mp4"
            >
              Your browser does not support the video tag.
            </video>
          </div>
        </div>
      </div>
      <div class="p-4 flex justify-end gap-2">
        <button
          type="button"
          (click)="showEditLessonDialog = false"
          class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-200"
        >
          Hủy
        </button>
        <button
          type="submit"
          [disabled]="lessonForm.invalid || isSubmittingLesson"
          class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          {{ isSubmittingLesson ? "Đang cập nhật..." : "Cập nhật" }}
        </button>
      </div>
    </form>
  </ng-template>
</p-dialog>
